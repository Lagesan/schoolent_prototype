{% extends "layout.html" %}

{% block title %}åˆ›å»ºé—®å·{% endblock %}

{% block content %}
<h1>åˆ›å»ºæ–°é—®å·</h1>
<form id="surveyForm" method="POST" action="/create" enctype="multipart/form-data">
    <div class="form-group">
        <label>é—®å·æ ‡é¢˜</label>
        <input type="text" name="survey_title" required class="full-width">
    </div>

    <div id="questionsContainer">
        <!-- é—®é¢˜å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
    </div>

    <div class="toolbar">
        <button type="button" class="btn" data-action="addQuestion" data-question-type="text">
            <span class="icon">ğŸ“</span>æ·»åŠ æ–‡æœ¬
        </button>
        <button type="button" class="btn" data-action="addQuestion" data-question-type="radio">
            <span class="icon">ğŸ”˜</span>æ·»åŠ å•é€‰
        </button>
        <button type="button" class="btn" data-action="addQuestion" data-question-type="checkbox">
            <span class="icon">â˜‘ï¸</span>æ·»åŠ å¤šé€‰
        </button>
        <button type="button" class="btn" data-action="addQuestion" data-question-type="input">
            <span class="icon">ğŸ“©</span>æ·»åŠ ç®€ç­”
        </button>
    </div>

    <div class="form-footer">
        <button type="submit" class="btn primary large">
            <span class="icon">ğŸš€</span>å‘å¸ƒé—®å·
        </button>
    </div>
</form>

<script id="questionTemplate" type="text/template">
<div class="question-item" data-type="[[ type ]]" data-index="[[ index ]]">
    <div class="question-header">
        <h3>[[ title ]]</h3>
        <button type="button" class="btn danger small" data-action="removeQuestion">
            ğŸ—‘ï¸åˆ é™¤
        </button>
    </div>
    <div class="question-body">
        [[ content ]]
    </div>
</div>
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let questionIndex = 0;

    const questionConfig = {
        text: {
            title: 'æ–‡æœ¬åŒºå—',
            content: (index) => `
                <div class="form-group">
                    <textarea name="q_text_${index}_question" 
                              required 
                              placeholder="è¯·è¾“å…¥è¯´æ˜æ–‡å­—"
                              class="text-input"></textarea>
                </div>
            `
        },
        radio: {
            title: 'å•é€‰é¢˜',
            content: (index) => `
                <div class="form-group">
                    <input type="text" 
                        name="q_radio_${index}_question" 
                        required 
                        placeholder="è¯·è¾“å…¥é—®é¢˜å†…å®¹">
                </div>
                <div class="options-container" data-index="${index}">
                    <div class="option">
                        <input type="radio" name="q_radio_${index}_option" disabled>
                        <input type="text" 
                            name="q_radio_${index}_option_0" 
                            required 
                            placeholder="é€‰é¡¹å†…å®¹">
                        <div class="option-actions">
                            <button type="button" class="btn icon" 
                                    data-action="addOption" 
                                    data-question-type="radio">â•</button>
                        </div>
                    </div>
                </div>
            `
        },
        checkbox: {
            title: 'å¤šé€‰é¢˜',
            content: (index) => `
                <div class="form-group">
                    <input type="text" 
                        name="q_checkbox_${index}_question" 
                        required 
                        placeholder="è¯·è¾“å…¥é—®é¢˜å†…å®¹">
                </div>
                <div class="options-container" data-index="${index}">
                    <div class="option">
                        <input type="checkbox" name="q_checkbox_${index}_option" disabled>
                        <input type="text" 
                            name="q_checkbox_${index}_option_0" 
                            required 
                            placeholder="é€‰é¡¹å†…å®¹">
                        <div class="option-actions">
                            <button type="button" class="btn icon" 
                                    data-action="addOption" 
                                    data-question-type="checkbox">â•</button>
                        </div>
                    </div>
                </div>
            `
        },
        input: {
            title: 'ç®€ç­”é¢˜',
            content: (index) => `
                <div class="form-group">
                    <input type="text" 
                           name="q_input_${index}_question" 
                           required 
                           placeholder="è¯·è¾“å…¥é—®é¢˜å†…å®¹"
                           class="question-input">
                </div>
                <div class="form-group">
                    <textarea name="q_input_${index}_answer" 
                              disabled 
                              placeholder="ç”¨æˆ·å°†åœ¨æ­¤è¾“å…¥æ–‡æœ¬"
                              class="answer-input"></textarea>
                </div>
            `
        }
    };

    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const questionType = target.dataset.questionType;

        switch(action) {
            case 'addQuestion':
                addQuestion(questionType);
                break;
            case 'removeQuestion':
                removeQuestion(target.closest('.question-item'));
                break;
            case 'addOption':
                addOption(target, questionType);
                break;
            case 'removeOption':
                removeOption(target.closest('.option'));
                break;
        }
    });

    function addQuestion(type) {
        if (!questionConfig[type]) {
            console.error(`æœªçŸ¥çš„é—®é¢˜ç±»å‹: ${type}`);
            return;
        }

        const template = document.getElementById('questionTemplate').innerHTML;
        const config = questionConfig[type];
        const index = questionIndex++;
        
        const content = config.content(index)
            .replace(/\n/g, '')
            .replace(/ {2,}/g, '');

        const questionHTML = template
            .replace(/\[\[ title \]\]/g, config.title)
            .replace(/\[\[ content \]\]/g, content)
            .replace(/\[\[ index \]\]/g, index)
            .replace(/\[\[ type \]\]/g, type);

        const div = document.createElement('div');
        div.innerHTML = questionHTML;
        
        if (!div.firstElementChild) {
            console.error('ç”Ÿæˆçš„ HTML æ— æ•ˆ:', questionHTML);
            return;
        }

        const questionsContainer = document.getElementById('questionsContainer');
        if (!questionsContainer) {
            console.error('questionsContainer æœªæ‰¾åˆ°');
            return;
        }

        questionsContainer.appendChild(div.firstElementChild);
        
        div.firstElementChild.style.opacity = 0;
        setTimeout(() => {
            div.firstElementChild.style.opacity = 1;
            div.firstElementChild.style.transform = 'translateY(0)';
        }, 10);
    }

    function addOption(button, type) {
            const container = button.closest('.options-container');
            const index = container.dataset.index;
            const optionCount = container.querySelectorAll('.option').length;
            
            const optionHTML = `
                <div class="option">
                    <input type="${type === 'radio' ? 'radio' : 'checkbox'}" 
                        name="q_${type}_${index}_option" 
                        disabled>
                    <input type="text" 
                        name="q_${type}_${index}_option_${optionCount}" 
                        required 
                        placeholder="é€‰é¡¹å†…å®¹">
                    <div class="option-actions">
                        <button type="button" class="btn icon danger" 
                                data-action="removeOption">â–</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', optionHTML);
        }

    function removeQuestion(questionItem) {
        if (!questionItem) return;
        
        questionItem.style.transform = 'translateX(-100%)';
        questionItem.style.opacity = '0';
        setTimeout(() => questionItem.remove(), 300);
    }

    function removeOption(option) {
        if (!option) return;
        
        option.style.opacity = 0;
        setTimeout(() => option.remove(), 300);
    }

    document.getElementById('surveyForm').addEventListener('submit', function(e) {
        let isValid = true;
        const errorFields = [];

        const titleInput = this.querySelector('[name="survey_title"]');
        if (!titleInput.value.trim()) {
            errorFields.push(titleInput);
        }

        this.querySelectorAll('.question-item [required]').forEach(input => {
            if (!input.value.trim()) {
                errorFields.push(input);
            }
        });

        errorFields.forEach(field => field.classList.add('error'));
        
        if (errorFields.length > 0) {
            e.preventDefault();
            errorFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            alert('è¯·å®Œå–„æ‰€æœ‰æ ‡çº¢å­—æ®µå†…å®¹');
        }
    });

    document.addEventListener('input', function(e) {
        if (e.target.matches('[required]')) {
            e.target.classList.toggle('error', !e.target.value.trim());
        }
    });
});
</script>
{% endblock %}